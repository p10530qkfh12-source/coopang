name: ì¿ íŒ¡ ìë™ í¬ìŠ¤íŒ…

on:
  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST) ì‹¤í–‰ = UTC 0ì‹œ
  schedule:
    - cron: '0 0 * * *'

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      keyword:
        description: 'ê²€ìƒ‰ í‚¤ì›Œë“œ'
        required: true
        default: 'ë¬´ì„  ì´ì–´í°'
      count:
        description: 'ìƒí’ˆ ê°œìˆ˜'
        required: true
        default: '5'
      action:
        description: 'ì‹¤í–‰í•  ì‘ì—…'
        required: true
        default: 'publish'
        type: choice
        options:
          - publish
          - draft
          - blog
          - notify
          - report

env:
  NODE_VERSION: '18'

jobs:
  auto-publish:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ” í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        run: |
          cat > .env << EOF
          # ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ API
          COUPANG_ACCESS_KEY=${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY=${{ secrets.COUPANG_SECRET_KEY }}

          # Rate Limiting
          REQUEST_DELAY_MS=1000
          MAX_RETRIES=3
          TIMEOUT_MS=10000

          # ì›Œë“œí”„ë ˆìŠ¤
          WP_SITE_URL=${{ secrets.WP_SITE_URL }}
          WP_USERNAME=${{ secrets.WP_USERNAME }}
          WP_APP_PASSWORD=${{ secrets.WP_APP_PASSWORD }}

          # í…”ë ˆê·¸ë¨ (ì„ íƒ)
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          EOF

      - name: ğŸš€ ìë™ í¬ìŠ¤íŒ… ì‹¤í–‰ (ìŠ¤ì¼€ì¤„)
        if: github.event_name == 'schedule'
        run: |
          echo "ğŸ“ ì¼ì¼ ìë™ í¬ìŠ¤íŒ… ì‹œì‘..."
          # API í‚¤ê°€ ì—†ìœ¼ë©´ ìë™ ëª¨ë“œ ì‚¬ìš© (ìš”ì¼ë³„ ë¡œí…Œì´ì…˜)
          if [ -z "${{ secrets.COUPANG_ACCESS_KEY }}" ] || [ "${{ secrets.COUPANG_ACCESS_KEY }}" = "your_access_key_here" ]; then
            echo "ğŸ”„ ìë™ ëª¨ë“œ (ìš”ì¼ë³„ ë¡œí…Œì´ì…˜)..."
            npm run auto
          else
            echo "ğŸ”„ API ëª¨ë“œë¡œ í¬ìŠ¤íŒ…..."
            npm run publish "ì˜¤ëŠ˜ì˜ ì¶”ì²œ" 5
          fi
        continue-on-error: true

      - name: ğŸ¯ ìˆ˜ë™ ì‹¤í–‰
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ¯ ìˆ˜ë™ ì‹¤í–‰: ${{ github.event.inputs.action }}"
          if [ "${{ github.event.inputs.action }}" = "publish" ]; then
            # API í‚¤ê°€ ì—†ìœ¼ë©´ ìˆ˜ë™ ëª¨ë“œ ì‚¬ìš©
            if [ -z "${{ secrets.COUPANG_ACCESS_KEY }}" ] || [ "${{ secrets.COUPANG_ACCESS_KEY }}" = "your_access_key_here" ]; then
              echo "ğŸ”„ ìˆ˜ë™ ëª¨ë“œë¡œ í¬ìŠ¤íŒ…..."
              npm run manual:publish
            else
              npm run publish "${{ github.event.inputs.keyword }}" ${{ github.event.inputs.count }}
            fi
          else
            npm run ${{ github.event.inputs.action }} "${{ github.event.inputs.keyword }}" ${{ github.event.inputs.count }}
          fi

      - name: ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "## ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- ì‹œê°„: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
          echo "- íŠ¸ë¦¬ê±°: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ -d "data/posted_products.json" ]; then
            echo "- í¬ìŠ¤íŒ… ê¸°ë¡: ì¡´ì¬" >> $GITHUB_STEP_SUMMARY
          fi

  # ìˆ˜ìµ ë¦¬í¬íŠ¸ (ë§¤ì£¼ ì›”ìš”ì¼)
  weekly-report:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ“Š ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          echo "ğŸ“Š ì£¼ê°„ ë¦¬í¬íŠ¸ëŠ” CSV íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤."
          echo "ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ëŒ€ì‹œë³´ë“œì—ì„œ CSVë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”."
